<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ ì„±ì  í€˜ìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700;800&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; }
        
        /* ë¸Œëœë“œ í—¤ë” */
        .brand-header {
            background-color: #2c3e50;
            color: #fff;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            font-size: 18px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .brand-icon { margin-right: 10px; font-size: 22px; }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* í˜ì´ì§€ íƒ€ì´í‹€ */
        .page-title-area { text-align: center; margin: 20px 0 30px 0; position: relative; }
        .page-title { font-size: 28px; font-weight: 800; color: #2c3e50; margin: 0; display: inline-block; border-bottom: 3px solid #3498db; padding-bottom: 5px; }
        .btn-logout { position: absolute; right: 0; top: 0; background-color: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px; }

        /* ë¡œê·¸ì¸ ì„¹ì…˜ */
        #loginSection { max-width: 400px; margin: 80px auto; text-align: center; background: #fff; padding: 40px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .btn-google { background-color: #fff; color: #444; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 15px; font-size: 16px; width: 100%; cursor: pointer; border-radius: 6px; margin-top: 20px; transition: background 0.2s; }
        .btn-google:hover { background-color: #f8f9fa; }

        /* ë ˆì´ì•„ì›ƒ */
        .dashboard-layout { display: flex; flex-direction: column; gap: 20px; }
        .left-panel { flex: 1; display: flex; flex-direction: column; gap: 20px; order: 2; }
        .right-panel { 
            order: 1; 
            background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); padding: 15px; 
            position: sticky; top: 0; z-index: 999; 
            background-color: #f8f9fa; border-bottom: 1px solid #ddd;
        }

        @media (min-width: 900px) {
            .dashboard-layout { flex-direction: row; align-items: flex-start; }
            .left-panel { flex: 1; order: 1; } 
            .right-panel { 
                flex: 0 0 420px; order: 2; 
                position: sticky; top: 20px; 
                background: transparent; border: none; padding: 0; box-shadow: none;
            }
            .page-title-area { text-align: center; }
            .btn-logout { top: 5px; }
        }

        /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ (í•„í„° & ì •ë ¬) */
        .control-panel {
            background-color: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .control-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .control-row:last-child { margin-bottom: 0; }
        
        select { 
            flex: 1; padding: 10px; font-size: 14px; border: 1px solid #ddd; 
            border-radius: 8px; background: white; font-weight: bold; cursor: pointer;
        }
        select:focus { border-color: #3498db; outline: none; }
        
        .sort-label { font-size: 14px; font-weight: bold; color: #555; display: flex; align-items: center; margin-right: 10px; width: 80px;}

        /* ì°¨íŠ¸ ë””ìì¸ */
        .chart-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .chart-container { position: relative; height: 250px; width: 100%; overflow-x: auto; overflow-y: hidden; }
        .chart-scroll-wrapper { min-width: 100%; height: 100%; }

        /* ë“±ê¸‰ ê¸°ì¤€í‘œ */
        .grade-scale-bar { display: flex; height: 30px; border-radius: 15px; overflow: hidden; margin-top: 15px; font-weight: bold; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.3); font-size: 11px; }
        .scale-segment { flex: 1; display: flex; justify-content: center; align-items: center; }
        
        /* ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
        .bg-A { background-color: #fa5252; } 
        .bg-B { background-color: #fd7e14; } 
        .bg-C { background-color: #fab005; } 
        .bg-D { background-color: #51cf66; } 
        .bg-E { background-color: #339af0; } 

        /* ê³¼ëª© ì¹´ë“œ (ê²Œì´ë¯¸í”¼ì¼€ì´ì…˜) */
        .subject-card { 
            background: #fff; border-radius: 12px; margin-bottom: 15px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
            border: 1px solid #eee;
            cursor: pointer; overflow: hidden; transition: transform 0.2s;
            position: relative;
        }
        .subject-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.1); }
        
        /* ì™¼ìª½ ì»¬ëŸ¬ ë  ëŒ€ì‹  ìƒë‹¨ HPë°” ëŠë‚Œ */
        .hp-container {
            height: 6px; width: 100%; background: #eee;
            position: absolute; top: 0; left: 0;
        }
        .hp-fill { height: 100%; transition: width 1s ease-in-out; }

        .card-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .subject-info { display: flex; align-items: center; gap: 10px; }
        .subject-icon { font-size: 24px; }
        .subject-name { font-size: 18px; font-weight: 800; color: #2c3e50; }
        
        .score-display { text-align: right; }
        .rank-badge { 
            display: inline-block; padding: 4px 10px; border-radius: 20px; 
            color: white; font-weight: bold; font-size: 12px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); margin-bottom: 4px;
        }
        .current-score { font-size: 14px; color: #777; font-weight: 600; }
        .toggle-hint { font-size: 11px; color: #aaa; margin-top: 2px; }

        .card-body { padding: 0 20px 20px 20px; display: none; background-color: #fafafa; border-top: 1px solid #eee; }
        .card-body.expanded { display: block; animation: slideDown 0.3s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* ì…ë ¥ í¼ */
        .input-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .input-row:last-child { border-bottom: none; }
        .item-name { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .item-meta { font-size: 12px; color: #888; }
        .score-input { width: 60px; padding: 8px; border: 2px solid #eee; border-radius: 8px; text-align: center; font-size: 16px; background: #fff; font-weight: bold; color: #333; transition: border-color 0.2s; }
        .score-input:focus { border-color: #3498db; outline: none; }
        
        .badge-type { padding: 2px 6px; border-radius: 4px; font-size: 10px; color: white; margin-right: 6px; vertical-align: middle; }
        .b-ji { background: #e74c3c; } .b-su { background: #3498db; }

        .hidden { display: none !important; }
        .alert-box { background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-size: 13px; font-weight: bold;}
    </style>
</head>
<body>

    <div id="loginSection">
        <h2>âš”ï¸ ì„±ì  í€˜ìŠ¤íŠ¸ ë¡œê·¸ì¸</h2>
        <p>êµ¬ê¸€ ê³„ì •ìœ¼ë¡œ ì ‘ì†í•˜ì—¬<br>ë‚˜ì˜ í•™ìŠµ ë ˆë²¨ì„ í™•ì¸í•˜ì„¸ìš”.</p>
        <button class="btn-google" onclick="loginWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="G" width="20">
            Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
        </button>
    </div>

    <div id="appSection" class="hidden">
        <header class="brand-header">
            <span class="brand-icon">ğŸ›¡ï¸</span>
            ìš©ì‹ ì¤‘í•™êµ í•™ìŠµ ê¸¸ë“œ
        </header>

        <div class="container">
            <div class="page-title-area">
                <h1 class="page-title">ğŸ“Š ë‚˜ì˜ ìŠ¤í…Œì´í„°ìŠ¤</h1>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="dashboard-layout">
                
                <div class="left-panel">
                    
                    <div class="control-panel">
                        <div class="control-row">
                            <span class="sort-label">ğŸ“… í•™ê¸° ì„ íƒ</span>
                            <select id="yearFilter" onchange="renderDashboard()">
                                <option value="2025">2025í•™ë…„ë„</option>
                                <option value="2026">2026í•™ë…„ë„</option>
                            </select>
                            <select id="semesterFilter" onchange="renderDashboard()">
                                <option value="1í•™ê¸°">1í•™ê¸°</option>
                                <option value="2í•™ê¸°">2í•™ê¸°</option>
                            </select>
                        </div>
                        <div class="control-row">
                            <span class="sort-label">ğŸ” ì •ë ¬ ê¸°ì¤€</span>
                            <select id="sortFilter" onchange="renderDashboard()">
                                <option value="default">ğŸ“œ êµê³¼í‘œ ìˆœì„œ (êµ­ì˜ìˆ˜...)</option>
                                <option value="score">ğŸ”¥ ì „íˆ¬ë ¥(ì„±ì ) ë†’ì€ ìˆœ</option>
                                <option value="name">ğŸ”¡ ê³¼ëª© ì´ë¦„ ìˆœ</option>
                            </select>
                        </div>
                    </div>

                    <div class="alert-box">
                        ğŸ’¾ ì…ë ¥í•œ ì ìˆ˜ëŠ” ì„œë²„ì— ì €ì¥ë˜ì§€ ì•Šê³  ë‚´ ì»´í“¨í„°ì—ë§Œ ë‚¨ìŠµë‹ˆë‹¤.<br>(ê°œì¸ì •ë³´ ë³´í˜¸ ì•ˆì‹¬ êµ¬ì—­)
                    </div>

                    <div id="subjectsList">
                        </div>
                </div>

                <div class="right-panel">
                    <div class="chart-card">
                        <h3 style="margin:0 0 15px 0; font-size:16px;">ğŸ“ˆ ëŠ¥ë ¥ì¹˜ ê·¸ë˜í”„</h3>
                        <div class="chart-container">
                            <div class="chart-scroll-wrapper">
                                <canvas id="gradeChart"></canvas>
                            </div>
                        </div>
                        <div class="grade-scale-bar">
                            <div class="scale-segment bg-A">Master</div>
                            <div class="scale-segment bg-B">Diamond</div>
                            <div class="scale-segment bg-C">Platinum</div>
                            <div class="scale-segment bg-D">Gold</div>
                            <div class="scale-segment bg-E">Novice</div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
          authDomain: "history-quiz-yongsin.firebaseapp.com",
          projectId: "history-quiz-yongsin",
          storageBucket: "history-quiz-yongsin.firebasestorage.app",
          messagingSenderId: "177587430482",
          appId: "1:177587430482:web:1188e0f661368040c3ab8b",
          measurementId: "G-YG2SLS45D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let allGradingPlans = [];
        let myChart = null;
        
        // ì •ë ¬ ìˆœì„œ ìƒìˆ˜ (êµê³¼í‘œ ìˆœ)
        const SUBJECT_ORDER = ['êµ­ì–´', 'ì˜ì–´', 'ìˆ˜í•™', 'ê³¼í•™', 'ì—­ì‚¬', 'ê¸°ê°€', 'í•œë¬¸', 'ì¼ë³¸ì–´', 'ë¯¸ìˆ ', 'ì²´ìœ¡'];

        // ê²Œì„ ë“±ê¸‰ ë° ìƒ‰ìƒ ì •ì˜
        const gameRanks = {
            A: { label: 'Master', icon: 'ğŸ†', color: '#fa5252' },
            B: { label: 'Diamond', icon: 'ğŸ’', color: '#fd7e14' },
            C: { label: 'Platinum', icon: 'âš”ï¸', color: '#fab005' },
            D: { label: 'Gold', icon: 'ğŸ›¡ï¸', color: '#51cf66' },
            E: { label: 'Novice', icon: 'ğŸŒ±', color: '#339af0' }
        };

        function getRankInfo(score) {
            if (score >= 90) return gameRanks.A;
            if (score >= 80) return gameRanks.B;
            if (score >= 70) return gameRanks.C;
            if (score >= 60) return gameRanks.D;
            return gameRanks.E;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('appSection').classList.remove('hidden');
                loadAllData();
            } else {
                document.getElementById('loginSection').classList.remove('hidden');
                document.getElementById('appSection').classList.add('hidden');
            }
        });

        window.loginWithGoogle = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { console.error(e); alert("ë¡œê·¸ì¸ ì‹¤íŒ¨"); } };
        window.logout = async () => { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { await signOut(auth); location.reload(); } };

        async function loadAllData() {
            try {
                // ì„ ìƒë‹˜ì´ ë§Œë“  í‰ê°€ ê³„íš(ë¬¸ì œì§€ ì •ë³´)ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤. ì ìˆ˜ëŠ” ê°€ì ¸ì˜¤ì§€ ì•ŠìŠµë‹ˆë‹¤.
                const q = query(collection(db, "grading_plans"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);
                allGradingPlans = [];
                snapshot.forEach(doc => allGradingPlans.push({ id: doc.id, ...doc.data() }));
                renderDashboard();
            } catch (e) { console.error(e); }
        }

        window.toggleCard = (cardHeader) => {
            const body = cardHeader.nextElementSibling;
            if (body.classList.contains('expanded')) {
                body.classList.remove('expanded');
            } else {
                body.classList.add('expanded');
            }
        };

        // ì ìˆ˜ ê³„ì‚° í—¬í¼ í•¨ìˆ˜
        function calculatePlanScore(plan) {
            let totalScore = 0;
            plan.items.forEach((item, idx) => {
                // localStorageì—ì„œë§Œ ì½ì–´ì˜µë‹ˆë‹¤. (DB ì‚¬ìš© X)
                const savedScore = localStorage.getItem(`score_${plan.id}_${idx}`);
                const scoreVal = parseFloat(savedScore);
                if(!isNaN(scoreVal)) {
                    totalScore += (scoreVal / item.maxScore) * item.ratio;
                }
            });
            return parseFloat(totalScore.toFixed(1));
        }

        window.renderDashboard = () => {
            const year = document.getElementById('yearFilter').value;
            const semester = document.getElementById('semesterFilter').value;
            const sortMode = document.getElementById('sortFilter').value; // ì •ë ¬ ì˜µì…˜
            const container = document.getElementById('subjectsList');
            container.innerHTML = '';

            // 1. í•™ê¸° í•„í„°ë§
            let targetPlans = allGradingPlans.filter(plan => {
                const planYear = plan.academicYear || "2025";
                const planSem = plan.semester || "1í•™ê¸°";
                return planYear === year && planSem === semester;
            });

            // 2. ì ìˆ˜ ë¯¸ë¦¬ ê³„ì‚° (ì •ë ¬ì„ ìœ„í•´)
            targetPlans = targetPlans.map(plan => ({
                ...plan,
                currentScore: calculatePlanScore(plan)
            }));

            // 3. ì •ë ¬ ë¡œì§ ì ìš©
            if (sortMode === 'score') {
                targetPlans.sort((a, b) => b.currentScore - a.currentScore);
            } else if (sortMode === 'name') {
                targetPlans.sort((a, b) => a.subject.localeCompare(b.subject));
            } else {
                // ê¸°ë³¸ êµê³¼í‘œ ìˆœì„œ
                targetPlans.sort((a, b) => {
                    let idxA = SUBJECT_ORDER.indexOf(a.subject);
                    let idxB = SUBJECT_ORDER.indexOf(b.subject);
                    if(idxA === -1) idxA = 999; 
                    if(idxB === -1) idxB = 999;
                    return idxA - idxB;
                });
            }

            if (targetPlans.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">í€˜ìŠ¤íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                updateChart([], [], []); return;
            }

            const chartLabels = []; const chartData = []; const chartColors = [];

            targetPlans.forEach(plan => {
                const finalScore = plan.currentScore;
                const { label, icon, color } = getRankInfo(finalScore);

                chartLabels.push(plan.subject);
                chartData.push(finalScore);
                chartColors.push(color);

                // ì¹´ë“œ ìƒì„±
                const card = document.createElement('div');
                card.className = 'subject-card';
                
                let inputHtml = '';
                plan.items.forEach((item, idx) => {
                    const savedScore = localStorage.getItem(`score_${plan.id}_${idx}`) || "";
                    const badgeClass = item.type === 'ì§€í•„' ? 'b-ji' : 'b-su';
                    
                    inputHtml += `
                        <div class="input-row">
                            <div class="item-info">
                                <div class="item-name"><span class="badge-type ${badgeClass}">${item.type}</span>${item.name}</div>
                                <div class="item-meta">${item.maxScore}ì  ë§Œì  / ${item.ratio}% ë°˜ì˜</div>
                            </div>
                            <input type="number" class="score-input" 
                                data-docid="${plan.id}" data-idx="${idx}" data-max="${item.maxScore}" 
                                value="${savedScore}" placeholder="0" onclick="event.stopPropagation()">
                        </div>`;
                });

                card.innerHTML = `
                    <div class="hp-container">
                        <div class="hp-fill" id="hp_${plan.id}" style="width:${finalScore}%; background-color:${color};"></div>
                    </div>
                    <div class="card-header" onclick="toggleCard(this)">
                        <div class="subject-info">
                            <span class="subject-icon">${icon}</span>
                            <div class="subject-name">${plan.subject}</div>
                        </div>
                        <div class="score-display">
                            <div class="rank-badge" id="badge_${plan.id}" style="background-color:${color}">${label}</div>
                            <div class="current-score"><span id="score_${plan.id}">${finalScore}</span> HP</div>
                            <div class="toggle-hint">â–¼ ì ìˆ˜ ì…ë ¥</div>
                        </div>
                    </div>
                    <div class="card-body">${inputHtml}</div>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.score-input').forEach(input => input.addEventListener('input', handleInput));
            updateChart(chartLabels, chartData, chartColors);
        };

        // ì…ë ¥ í•¸ë“¤ëŸ¬: DB ì €ì¥ ì ˆëŒ€ ì•ˆ í•¨. LocalStorageë§Œ ì‚¬ìš©.
        function handleInput(e) {
            const docId = e.target.dataset.docid;
            const idx = e.target.dataset.idx;
            const max = parseFloat(e.target.dataset.max);
            let val = e.target.value;
            
            if(val > max) { val = max; e.target.value = max; }
            if(val < 0) { val = 0; e.target.value = 0; }
            
            // â˜… ì¤‘ìš”: ë¸Œë¼ìš°ì € ì„ì‹œ ì €ì¥ì†Œì—ë§Œ ì €ì¥
            localStorage.setItem(`score_${docId}_${idx}`, val);
            
            updateCardScore(docId);
        }

        function updateCardScore(docId) {
            // í˜„ì¬ í™”ë©´ì˜ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ê³„ì‚°í•´ì„œ UIë§Œ ì—…ë°ì´íŠ¸
            const plan = allGradingPlans.find(p => p.id === docId);
            if(!plan) return;
            
            const finalScore = calculatePlanScore(plan);
            const { label, icon, color } = getRankInfo(finalScore);
            
            // UI ì—…ë°ì´íŠ¸
            document.getElementById(`score_${docId}`).innerText = finalScore;
            const badge = document.getElementById(`badge_${docId}`);
            badge.innerText = label;
            badge.style.backgroundColor = color;
            
            const hpBar = document.getElementById(`hp_${docId}`);
            hpBar.style.width = `${finalScore}%`;
            hpBar.style.backgroundColor = color;
            
            // ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ (DOM íƒìƒ‰ í•„ìš”)
            const card = badge.closest('.subject-card');
            card.querySelector('.subject-icon').innerText = icon;

            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            if(myChart) {
                // ì°¨íŠ¸ ë ˆì´ë¸”ì´ ì •ë ¬ ìƒíƒœì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¸ë±ìŠ¤ ì°¾ê¸° ì£¼ì˜
                const dataIndex = myChart.data.labels.indexOf(plan.subject);
                if(dataIndex !== -1) {
                    myChart.data.datasets[0].data[dataIndex] = finalScore;
                    myChart.data.datasets[0].backgroundColor[dataIndex] = color;
                    myChart.update();
                }
            }
        }

        function updateChart(labels, data, colors) {
            const ctx = document.getElementById('gradeChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{ label: 'ì „íˆ¬ë ¥(ì ìˆ˜)', data: data, backgroundColor: colors, borderWidth: 0, borderRadius: 6 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { 
                        y: { beginAtZero: true, max: 100, display: false }, 
                        x: { ticks:{font:{size:11, weight:'bold'}} } 
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
    </script>
</body>
</html>
