<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WeStory - 학생 관리</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f9fafb; margin: 0; padding: 0; display: flex; flex-direction: column; min-height: 100vh; }
        
        /* --- [헤더 스타일] --- */
        header { background-color: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; height: 64px; }
        .header-container { max-width: 80rem; margin: 0 auto; padding: 0 1.5rem; height: 100%; display: flex; align-items: center; justify-content: space-between; }
        
        /* 로고 */
        .logo-text { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.025em; cursor: pointer; display: flex; align-items: center; }
        .logo-we { color: #2563eb; }
        .logo-story { color: #f59e0b; }

        /* PC용 네비게이션 (1000px 이상에서만 보임) */
        .desktop-nav { display: flex; height: 100%; }
        .nav-link { font-weight: 500; color: #6b7280; margin: 0 1rem; text-decoration: none; font-size: 0.95rem; height: 100%; display: inline-flex; align-items: center; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-link:hover { color: #111827; }
        .nav-link.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 700; }

        /* 모바일 햄버거 버튼 (1000px 미만에서만 보임) */
        .mobile-menu-btn { display: none; margin-left: 1rem; font-size: 1.5rem; color: #374151; cursor: pointer; }
        
        /* 모바일 드롭다운 메뉴 */
        #mobile-menu { display: none; background-color: white; border-bottom: 1px solid #e5e7eb; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: absolute; top: 64px; left: 0; width: 100%; z-index: 49; }
        .mobile-link { display: flex; align-items: center; padding: 1rem 1.5rem; color: #374151; font-weight: 500; border-bottom: 1px solid #f3f4f6; text-decoration: none; transition: background 0.2s; }
        .mobile-link:hover { background-color: #f9fafb; }
        .mobile-link.active { color: #2563eb; background-color: #eff6ff; font-weight: 700; }
        .mobile-icon { width: 20px; height: 20px; margin-right: 12px; fill: currentColor; }

        /* 반응형 미디어 쿼리 (1000px 기준) */
        @media (max-width: 1000px) {
            .desktop-nav { display: none; }
            .mobile-menu-btn { display: block; }
        }

        /* 테이블 및 기타 스타일 */
        .admin-table th, .admin-table td { border-bottom: 1px solid #e5e7eb; vertical-align: middle; }
        .admin-table th:not(:last-child), .admin-table td:not(:last-child) { border-right: 1px solid #e5e7eb; }
        
        /* 로딩 오버레이 */
        #loading-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; color: white; }
    </style>
</head>
<body class="text-stone-800">

    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-white border-solid mb-4"></div>
        <p class="text-xl font-bold">처리 중입니다...</p>
    </div>

    <header>
        <div class="header-container">
            <div class="logo-text" onclick="location.href='index-test.html'">
                <span class="logo-we">We</span><span class="logo-story">story</span>
            </div>

            <nav class="desktop-nav">
                <a href="teacher_quiz-admin.html" class="nav-link">역사 퀴즈 대시보드</a>
                <a href="teacher_student-list-admin.html" class="nav-link active">학생 관리</a>
                <a href="teacher_yourscore-admin.html" class="nav-link">성적 산출 관리</a>
            </nav>

            <div class="flex items-center">
                <button onclick="app.logout()" class="text-stone-500 hover:text-stone-800 text-sm font-bold py-2 px-3 rounded hover:bg-stone-100 transition">
                    로그아웃
                </button>
                <button class="mobile-menu-btn" onclick="app.toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <div id="mobile-menu">
            <a href="teacher_quiz-admin.html" class="mobile-link">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z"></path></svg>
                역사 퀴즈 대시보드
            </a>
            <a href="teacher_student-list-admin.html" class="mobile-link active">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M12 3L1 9l11 6 9-4.91V17h2V9M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82z"></path></svg>
                학생 관리
            </a>
            <a href="teacher_yourscore-admin.html" class="mobile-link">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-6 1.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5-1.5-.67-1.5-1.5.67-1.5 1.5-1.5zM7.5 15.5H9v2H7.5v-2zm0-4H9v2H7.5v-2zm4.5 4H16v2h-4v-2zm0-4H16v2h-4v-2zm4.5 4H18v2h-1.5v-2zm0-4H18v2h-1.5v-2z"></path></svg>
                성적 산출 관리
            </a>
        </div>
    </header>

    <div id="view-dashboard" class="flex-1 max-w-7xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8" style="display:none;">
        <div class="bg-white p-6 rounded shadow border border-stone-200">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 bg-stone-50 p-4 rounded border border-stone-100 gap-4">
                <h2 class="font-bold text-lg text-stone-800 flex items-center">
                    <i class="fas fa-user-graduate text-blue-600 mr-2"></i> 가입 학생 목록 <span id="student-total-count" class="text-sm text-stone-500 ml-2"></span>
                </h2>
                <div class="flex gap-2 items-center flex-wrap w-full md:w-auto">
                    <select id="student-sort-select" onchange="app.loadStudents()" class="p-2 border rounded text-xs bg-white flex-1 md:flex-none">
                        <option value="class">반 번호순</option>
                        <option value="recent">최신 가입일순</option>
                    </select>
                    <div class="flex flex-1 md:flex-none">
                        <input type="text" id="search-student-mgmt" placeholder="이름/반 검색" class="p-2 border rounded-l text-xs w-full md:w-32" onkeypress="if(event.key==='Enter') app.filterStudents()">
                        <button onclick="app.filterStudents()" class="bg-stone-800 text-white px-3 py-2 rounded-r text-xs font-bold">검색</button>
                    </div>
                    <button onclick="document.getElementById('add-student-modal').style.display='flex'" class="bg-green-600 text-white px-3 py-2 rounded text-xs font-bold"><i class="fas fa-plus"></i> 추가</button>
                    <button onclick="app.loadStudents()" class="bg-indigo-600 text-white px-3 py-2 rounded text-xs font-bold"><i class="fas fa-sync"></i></button>
                </div>
            </div>

            <div class="overflow-auto max-h-[600px] border rounded bg-stone-50">
                <table class="w-full text-sm text-left admin-table">
                    <thead class="bg-stone-200 text-stone-700 sticky top-0 font-bold">
                        <tr>
                            <th class="p-3 w-16 text-center">반</th>
                            <th class="p-3 w-16 text-center">번호</th>
                            <th class="p-3">이름 (기록 조회)</th>
                            <th class="p-3">이메일</th>
                            <th class="p-3 text-center w-32">가입일</th>
                            <th class="p-3 text-center w-24">관리</th>
                        </tr>
                    </thead>
                    <tbody id="student-list-body" class="bg-white">
                        <tr><td colspan="6" class="p-10 text-center text-stone-500">데이터를 불러오는 중...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="view-login-screen" style="display: flex;" class="flex-1 items-center justify-center flex-col bg-stone-50 p-4">
        <div class="bg-white p-8 rounded-xl shadow-lg max-w-sm w-full text-center border border-stone-200">
            <h1 class="text-2xl font-bold mb-2 text-stone-800">교사 인증</h1>
            <button onclick="app.login()" class="w-full bg-white border border-stone-300 text-stone-700 font-bold py-3 px-4 rounded shadow-sm hover:bg-stone-50 flex items-center justify-center gap-2 transition cursor-pointer">
                <i class="fab fa-google text-red-500"></i> 구글 계정으로 로그인
            </button>
        </div>
    </div>

    <div id="add-student-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="document.getElementById('add-student-modal').style.display='none'"></div>
        <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-sm mx-4">
            <h3 class="font-bold text-xl mb-4 border-b pb-2">학생 수동 추가</h3>
            <div class="space-y-4">
                <div class="flex gap-2">
                    <div class="flex-1"><label class="block text-sm font-bold mb-1">반</label><input type="number" id="add-std-class" class="w-full p-2 border rounded"></div>
                    <div class="flex-1"><label class="block text-sm font-bold mb-1">번호</label><input type="number" id="add-std-number" class="w-full p-2 border rounded"></div>
                </div>
                <div><label class="block text-sm font-bold mb-1">이름</label><input type="text" id="add-std-name" class="w-full p-2 border rounded"></div>
                <div class="flex gap-2 pt-2">
                    <button onclick="app.addStudentManual()" class="flex-1 bg-amber-600 text-white font-bold py-3 rounded">추가</button>
                    <button onclick="document.getElementById('add-student-modal').style.display='none'" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded">취소</button>
                </div>
            </div>
        </div>
    </div>

    <div id="student-edit-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="document.getElementById('student-edit-modal').style.display='none'"></div>
        <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-sm mx-4">
            <h3 class="font-bold text-xl mb-4 border-b pb-2">학생 정보 수정</h3>
            <input type="hidden" id="edit-std-docId">
            <div class="space-y-4">
                <div><label class="block text-sm font-bold mb-1">이메일</label><input type="text" id="edit-std-email" class="w-full p-2 border rounded bg-gray-100" readonly></div>
                <div class="flex gap-2">
                    <div class="flex-1"><label class="block text-sm font-bold mb-1">반</label><input type="number" id="edit-std-class" class="w-full p-2 border rounded"></div>
                    <div class="flex-1"><label class="block text-sm font-bold mb-1">번호</label><input type="number" id="edit-std-number" class="w-full p-2 border rounded"></div>
                </div>
                <div><label class="block text-sm font-bold mb-1">이름</label><input type="text" id="edit-std-name" class="w-full p-2 border rounded"></div>
                <div class="flex gap-2 pt-2">
                    <button onclick="app.saveStudentInfo()" class="flex-1 bg-green-600 text-white font-bold py-3 rounded">저장</button>
                    <button onclick="document.getElementById('student-edit-modal').style.display='none'" class="flex-1 bg-stone-200 text-stone-700 font-bold py-3 rounded">취소</button>
                </div>
            </div>
        </div>
    </div>

    <div id="student-history-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="document.getElementById('student-history-modal').style.display='none'"></div>
        <div class="bg-white p-6 rounded-lg shadow-xl z-10 w-full max-w-3xl mx-4 max-h-[85vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="font-bold text-xl"><span id="history-student-name" class="text-indigo-700"></span> 학습 기록</h3>
                <button onclick="document.getElementById('student-history-modal').style.display='none'" class="text-gray-500 hover:text-black"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="history-list-content" class="overflow-y-auto flex-1 bg-stone-50 p-4 rounded border border-stone-200 space-y-3"></div>
        </div>
    </div>

    <footer class="text-center py-8 text-stone-400 text-sm border-t bg-white mt-auto">
        Copyright © 역사교사 방재석
    </footer>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU", authDomain: "history-quiz-yongsin.firebaseapp.com", projectId: "history-quiz-yongsin", storageBucket: "history-quiz-yongsin.firebasestorage.app", messagingSenderId: "177587430482", appId: "1:177587430482:web:d79cc145c11e335cc3ab8b", measurementId: "G-LHN97D7R2R" };
        let db; try { if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); } db = firebase.firestore(); } catch(e) { console.error("Firebase Init Error", e); }
        const TEACHER_EMAIL = "westoria28@gmail.com";

        const app = {
            state: { students: [] },
            
            init: function() {
                firebase.auth().onAuthStateChanged((user) => {
                    if (user && user.email === TEACHER_EMAIL) {
                        document.getElementById('view-login-screen').style.display = 'none';
                        document.getElementById('view-dashboard').style.display = 'block';
                        this.loadStudents();
                    } else {
                        if(user) { alert("권한이 없습니다."); firebase.auth().signOut(); }
                        document.getElementById('view-login-screen').style.display = 'flex';
                        document.getElementById('view-dashboard').style.display = 'none';
                    }
                });
            },
            
            // 모바일 메뉴 토글 함수
            toggleMobileMenu: function() {
                const menu = document.getElementById('mobile-menu');
                if (menu.style.display === 'block') {
                    menu.style.display = 'none';
                } else {
                    menu.style.display = 'block';
                }
            },

            login: function() { const p = new firebase.auth.GoogleAuthProvider(); firebase.auth().signInWithPopup(p).catch(e => alert(e.message)); },
            logout: function() { firebase.auth().signOut().then(() => location.reload()); },
            showLoading: function(s) { document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none'; },

            loadStudents: function() {
                this.showLoading(true);
                db.collection("users").get().then((sn) => {
                    const list = [];
                    sn.forEach(doc => {
                        let d = doc.data(); d.docId = doc.id;
                        d.class = d.class ? parseInt(d.class) : 0; d.number = d.number ? parseInt(d.number) : 0;
                        list.push(d);
                    });
                    
                    const sortType = document.getElementById('student-sort-select').value;
                    if(sortType === 'recent') {
                        list.sort((a, b) => {
                            const tA = a.createdAt ? a.createdAt.toMillis() : (a.timestamp ? a.timestamp.toMillis() : 0);
                            const tB = b.createdAt ? b.createdAt.toMillis() : (b.timestamp ? b.timestamp.toMillis() : 0);
                            return tB - tA;
                        });
                    } else {
                        list.sort((a, b) => (a.class !== b.class) ? a.class - b.class : a.number - b.number);
                    }
                    
                    this.state.students = list; this.renderList(list); this.showLoading(false);
                }).catch(e => { this.showLoading(false); alert("로드 실패: " + e.message); });
            },

            renderList: function(list) {
                document.getElementById('student-total-count').innerText = `(${list.length}명)`;
                let html = '';
                if(list.length === 0) html = '<tr><td colspan="6" class="p-10 text-center text-stone-400">학생 데이터 없음</td></tr>';
                else {
                    list.forEach(s => {
                        let dateStr = '-';
                        if(s.createdAt && s.createdAt.toDate) dateStr = s.createdAt.toDate().toLocaleDateString();
                        else if(s.timestamp && s.timestamp.toDate) dateStr = s.timestamp.toDate().toLocaleDateString();
                        
                        html += `<tr class="border-b hover:bg-stone-50"><td class="p-3 text-center font-bold text-lg text-stone-700">${s.class}</td>
                        <td class="p-3 text-center font-bold text-lg text-stone-700">${s.number}</td>
                        <td class="p-3"><span onclick="app.loadHistory('${s.name}','${s.class}','${s.number}')" class="cursor-pointer font-bold text-indigo-700 hover:underline flex items-center gap-1">${s.name || '이름없음'} <i class="fas fa-search-plus text-xs text-indigo-300"></i></span></td>
                        <td class="p-3 text-xs text-gray-500">${s.email || '-'}</td>
                        <td class="p-3 text-center text-xs text-gray-400">${dateStr}</td>
                        <td class="p-3 text-center"><button onclick="app.openEdit('${s.docId}')" class="text-blue-400 hover:text-blue-600 mr-2"><i class="fas fa-pen"></i></button><button onclick="app.deleteStudent('${s.docId}')" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></td></tr>`;
                    });
                }
                document.getElementById('student-list-body').innerHTML = html;
            },

            filterStudents: function() {
                const k = document.getElementById('search-student-mgmt').value.trim();
                if(!k) { this.renderList(this.state.students); return; }
                const f = this.state.students.filter(s => (s.name||"").includes(k) || String(s.class) === k);
                this.renderList(f);
            },

            // 학생 관리 (추가/수정/삭제)
            addStudentManual: function() {
                const c = parseInt(document.getElementById('add-std-class').value);
                const n = parseInt(document.getElementById('add-std-number').value);
                const nm = document.getElementById('add-std-name').value.trim();
                if(isNaN(c) || isNaN(n) || !nm) { alert("입력값 확인 필요"); return; }
                this.showLoading(true);
                db.collection("users").add({ class: c, number: n, name: nm, email: "", createdAt: firebase.firestore.FieldValue.serverTimestamp() })
                    .then(() => { alert("추가됨"); document.getElementById('add-student-modal').style.display='none'; this.loadStudents(); })
                    .catch(e => { this.showLoading(false); alert("실패: "+e.message); });
            },
            openEdit: function(id) {
                const s = this.state.students.find(x => x.docId === id); if(!s) return;
                document.getElementById('edit-std-docId').value = s.docId; document.getElementById('edit-std-email').value = s.email||"";
                document.getElementById('edit-std-class').value = s.class; document.getElementById('edit-std-number').value = s.number; document.getElementById('edit-std-name').value = s.name;
                document.getElementById('student-edit-modal').style.display='flex';
            },
            saveStudentInfo: function() {
                const id = document.getElementById('edit-std-docId').value;
                const c = parseInt(document.getElementById('edit-std-class').value);
                const n = parseInt(document.getElementById('edit-std-number').value);
                const nm = document.getElementById('edit-std-name').value.trim();
                this.showLoading(true);
                db.collection("users").doc(id).update({ class: c, number: n, name: nm }).then(() => { alert("수정됨"); document.getElementById('student-edit-modal').style.display='none'; this.loadStudents(); });
            },
            deleteStudent: function(id) {
                if(confirm("삭제하시겠습니까?")) { this.showLoading(true); db.collection("users").doc(id).delete().then(() => { alert("삭제됨"); this.loadStudents(); }); }
            },
            loadHistory: function(name, cls, num) {
                this.showLoading(true);
                document.getElementById('history-student-name').innerText = `${cls}반 ${num}번 ${name}`;
                db.collection("quiz_results").where("name", "==", name).orderBy("timestamp", "desc").get().then(sn => {
                    let h = "";
                    if(sn.empty) h = `<div class="text-center p-10 text-gray-400">기록 없음</div>`;
                    else sn.forEach(d => { const data = d.data(); h += `<div class="border p-3 rounded mb-2 bg-stone-50"><div class="font-bold text-sm">${data.timeString}</div><div class="text-lg font-bold text-blue-600">${data.score}점</div></div>`; });
                    document.getElementById('history-list-content').innerHTML = h;
                    document.getElementById('student-history-modal').style.display='flex';
                    this.showLoading(false);
                });
            }
        };
        window.onload = function() { app.init(); };
        // 메뉴 외부 클릭 시 닫기
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mobile-menu');
            const btn = document.querySelector('.mobile-menu-btn');
            if (!menu.contains(e.target) && !btn.contains(e.target)) { menu.style.display = 'none'; }
        });
    </script>
</body>
</html>
