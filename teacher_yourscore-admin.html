<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>êµì‚¬ ëŒ€ì‹œë³´ë“œ - ì„±ì  ì‚°ì¶œ ê´€ë¦¬</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #f0f2f5; margin: 0; padding: 0; color: #333; }
        a { text-decoration: none; color: inherit; }
        * { box-sizing: border-box; }

        /* [ê³µí†µ í—¤ë” ê°€ì´ë“œë¼ì¸] + ë°˜ì‘í˜• */
        header { background-color: white; border-bottom: 1px solid #e5e7eb; position: sticky; top: 0; z-index: 50; }
        
        .header-container { 
            max-width: 80rem; margin: 0 auto; padding: 0 1.5rem; 
            height: 64px; display: flex; align-items: center; justify-content: space-between; 
        }
        
        /* ë¡œê³  */
        .logo-text { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.025em; cursor: pointer; display: flex; align-items: center; }
        .logo-we { color: #2563eb; }
        .logo-story { color: #f59e0b; }

        /* PC ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-container { display: flex; height: 100%; }
        .nav-link { font-weight: 500; color: #6b7280; margin: 0 1rem; text-decoration: none; font-size: 0.95rem; height: 100%; display: inline-flex; align-items: center; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .nav-link:hover { color: #111827; }
        .nav-link.active { color: #2563eb; border-bottom-color: #2563eb; font-weight: 700; }

        /* ìš°ì¸¡ ì‚¬ìš©ì ì •ë³´ ë° ì•¡ì…˜ ê·¸ë£¹ */
        .right-actions { display: flex; align-items: center; gap: 15px; }

        /* í™˜ì˜ ë¬¸êµ¬ */
        .welcome-msg { font-size: 0.9rem; font-weight: 600; color: #4b5563; display: none; } /* ëª¨ë°”ì¼ì—” ê³µê°„ ë¶€ì¡±ìœ¼ë¡œ ìˆ¨ê¸¸ ìˆ˜ë„ ìˆìŒ */
        @media (min-width: 768px) { .welcome-msg { display: block; } }

        /* íƒ€ì´ë¨¸ ë°°ì§€ */
        .timer-badge {
            background-color: #ef4444; color: white; font-size: 0.85rem; font-weight: 700;
            padding: 4px 10px; border-radius: 9999px; display: flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
        .btn-logout-custom {
            color: #78716c; font-size: 0.875rem; font-weight: 700; padding: 0.5rem 0.75rem;
            border-radius: 0.25rem; background-color: transparent; border: none; cursor: pointer; transition: all 0.2s;
            white-space: nowrap;
        }
        .btn-logout-custom:hover { color: #292524; background-color: #f5f5f4; }

        /* í–„ë²„ê±° ë²„íŠ¼ */
        .hamburger-btn { display: none; background: none; border: none; font-size: 24px; cursor: pointer; color: #333; padding: 5px; }
        
        /* ëª¨ë°”ì¼ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ */
        .mobile-menu { display: none; background-color: #f8f9fa; border-top: 1px solid #e5e7eb; padding: 10px 0; position: absolute; width: 100%; left: 0; top: 64px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 49; }
        .mobile-menu.open { display: block; }
        .mobile-link { 
            display: flex; align-items: center; padding: 15px 20px; 
            font-size: 16px; font-weight: 500; color: #4b5563; 
            border-bottom: 1px solid #eee; transition: background 0.2s; 
        }
        .mobile-link:last-child { border-bottom: none; }
        .mobile-link:hover { background-color: #e5e7eb; }
        .mobile-link.active { color: #2563eb; background-color: #eff6ff; font-weight: 700; }
        .mobile-icon { margin-right: 12px; width: 20px; height: 20px; fill: currentColor; }

        /* ë°˜ì‘í˜• (1024px ì´í•˜) */
        @media (max-width: 1024px) {
            .nav-container { display: none; }
            .hamburger-btn { display: block; }
            .header-container { padding: 0 1rem; }
        }

        /* ë©”ì¸ ì»¨í…ì¸  ë ˆì´ì•„ì›ƒ */
        .container { max-width: 1600px; margin: 0 auto; padding: 30px 20px; min-height: calc(100vh - 200px); }
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .page-title { font-size: 24px; font-weight: 800; color: #2c3e50; margin: 0; border-bottom: 3px solid #3498db; padding-bottom: 5px; display: inline-block; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ (ì¸ì¦ ì²´í¬ ì¤‘ í‘œì‹œ) */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            font-size: 24px; font-weight: bold; color: #2563eb;
        }

        .dashboard-layout { display: flex; flex-direction: column; gap: 30px; }
        .left-panel { display: flex; flex-direction: column; gap: 20px; }
        .right-panel { display: flex; flex-direction: column; gap: 20px; }

        @media (min-width: 1000px) {
            .dashboard-layout { flex-direction: row; align-items: flex-start; }
            .left-panel { flex: 1; } 
            .right-panel { 
                flex: 1; height: calc(100vh - 120px); overflow-y: auto; 
                position: sticky; top: 84px; padding-right: 10px; 
            }
        }

        /* í•„í„° ë° ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .big-filter-card { background-color: #e3f2fd; border: 2px solid #2196f3; border-radius: 12px; padding: 20px; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.2); }
        .filter-header { font-size: 16px; font-weight: bold; color: #1565c0; margin-bottom: 10px; }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-row select { flex: 1; min-width: 100px; padding: 12px; font-size: 16px; border: 1px solid #90caf9; border-radius: 8px; background: white; font-weight: bold; cursor: pointer; }

        .input-card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-top: 5px solid #2ecc71; }
        .section-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        input:focus { border-color: #3498db; outline: none; }

        #criteriaList { background-color: #fafafa; padding: 15px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 15px; }
        .criteria-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .c-type { flex: 0 0 100px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .c-name { flex: 3; min-width: 120px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .c-max, .c-ratio { flex: 1; min-width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 4px; text-align: center; }
        .remove-btn { flex: 0 0 40px; background: #e74c3c; color: white; border: none; height: 38px; border-radius: 4px; cursor: pointer; }

        .btn-add { background-color: #3498db; color: white; padding: 12px; width: 100%; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-bottom: 10px; }
        .btn-save { background-color: #2ecc71; color: white; padding: 15px; width: 100%; border: none; border-radius: 6px; font-size: 18px; font-weight: bold; cursor: pointer; }
        .btn-cancel { background-color: #95a5a6; color: white; padding: 12px; width: 100%; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; margin-top: 10px; display: none; }

        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .sort-select { padding: 8px 12px; font-size: 14px; border: 1px solid #ffcc80; background-color: #fff3e0; border-radius: 6px; color: #e65100; font-weight: bold; cursor: pointer; }

        .plan-card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 5px solid #3498db; display: flex; justify-content: space-between; align-items: flex-start; transition: transform 0.2s; margin-bottom: 20px; }
        .plan-card:last-child { margin-bottom: 0; }
        .plan-card:hover { transform: translateX(5px); }
        
        .plan-info { flex: 1; margin-right: 20px; }
        .plan-info h3 { margin: 0 0 5px 0; font-size: 18px; color: #333; }
        .plan-meta { font-size: 13px; color: #666; }
        .plan-items { font-size: 13px; color: #555; margin-top: 10px; line-height: 1.6; background: #f9f9f9; padding: 10px; border-radius: 6px; white-space: normal; word-break: keep-all; }
        .plan-actions { display: flex; gap: 8px; flex-direction: row; flex-shrink: 0; }
        
        .btn-sm { padding: 8px 12px; border: none; border-radius: 4px; color: white; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-edit { background-color: #f39c12; }
        .btn-delete { background-color: #e74c3c; }

        .hidden { display: none !important; }
        .empty-msg { text-align: center; color: #999; padding: 40px; background: #fff; border-radius: 12px; }

        .main-footer { text-align: center; padding: 40px 0; color: #999; font-size: 14px; border-top: 1px solid #eee; margin-top: 40px; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    
    <div id="loadingOverlay">
        ğŸ”’ ë³´ì•ˆ ì ‘ì† í™•ì¸ ì¤‘...
    </div>

    <header>
        <div class="header-container">
            <div class="logo-text" onclick="goMain()">
                <span class="logo-we">We</span><span class="logo-story">story</span>
            </div>
    
            <nav class="nav-container">
                <a href="teacher_quiz-admin.html" class="nav-link">ì—­ì‚¬ í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ</a>
                <a href="teacher_student-list-admin.html" class="nav-link">í•™ìƒ ê´€ë¦¬</a>
                <a href="teacher_yourscore-admin.html" class="nav-link active">ì„±ì  ì‚°ì¶œ ê´€ë¦¬</a>
                <a href="teacher_markexam-2025-2sem.html" class="nav-link">ì‹œí—˜ ì±„ì  ê´€ë¦¬</a>
            </nav>
    
            <div class="right-actions">
                <span id="welcomeMsg" class="welcome-msg">ì„ ìƒë‹˜, í™”ì´íŒ…!</span>
                <div id="sessionTimer" class="timer-badge">
                    <i class="fas fa-clock"></i> <span>60:00</span>
                </div>
                <button onclick="handleLogout()" class="btn-logout-custom">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
                <button class="hamburger-btn" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>

        <div id="mobileMenu" class="mobile-menu">
            <a href="teacher_quiz-admin.html" class="mobile-link">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M5 9.2h3V19H5zM10.6 5h2.8v14h-2.8zm5.6 8H19v6h-2.8z"/><path d="M0 0h24v24H0z" fill="none"/></svg>
                ì—­ì‚¬ í€´ì¦ˆ ëŒ€ì‹œë³´ë“œ
            </a>
            <a href="teacher_student-list-admin.html" class="mobile-link">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z"/></svg>
                í•™ìƒ ê´€ë¦¬
            </a>
            <a href="teacher_yourscore-admin.html" class="mobile-link active">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zm-7-2h5v-2h-5v2zm0-4h5v-2h-5v2zm0-4h5V7h-5v2zM7 7h5v2H7V7zm0 4h5v2H7v-2zm0 4h5v2H7v-2z"/></svg>
                ì„±ì  ì‚°ì¶œ ê´€ë¦¬
            </a>
            <a href="teacher_markexam-2025-2sem.html" class="mobile-link">
                <svg class="mobile-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15-5-5 1.41-1.41L11 14.17l7.59-7.59L20 8l-9 9z"/></svg>
                ì‹œí—˜ ì±„ì  ê´€ë¦¬
            </a>
        </div>
    </header>

    <div class="container">
        <div class="page-header">
            <h1 class="page-title">ğŸ“ í‰ê°€ ê¸°ì¤€ ê´€ë¦¬</h1>
        </div>

        <div class="dashboard-layout">
            
            <div class="left-panel">
                <div class="big-filter-card">
                    <div class="filter-header">ğŸ“Œ ì¡°íšŒ í•„í„° ì„¤ì •</div>
                    <div class="filter-row">
                        <select id="yearFilter" onchange="handleFilterChange()">
                            <option value="2025">2025í•™ë…„ë„</option>
                            <option value="2026">2026í•™ë…„ë„</option>
                            <option value="2027">2027í•™ë…„ë„</option>
                        </select>
                        <select id="semesterFilter" onchange="handleFilterChange()">
                            <option value="1í•™ê¸°">1í•™ê¸°</option>
                            <option value="2í•™ê¸°">2í•™ê¸°</option>
                        </select>
                        <select id="gradeFilter" onchange="handleFilterChange()">
                            <option value="1í•™ë…„">1í•™ë…„</option>
                            <option value="2í•™ë…„">2í•™ë…„</option>
                            <option value="3í•™ë…„">3í•™ë…„</option>
                        </select>
                    </div>
                </div>

                <div class="input-card">
                    <div class="section-title">
                        <span id="formTitle">âœï¸ í‰ê°€ ê¸°ì¤€ ë“±ë¡</span>
                    </div>
                    
                    <div class="form-group">
                        <label>ê³¼ëª©ëª…</label>
                        <input type="text" id="subjectName" placeholder="ì˜ˆ: í•œêµ­ì‚¬, ì‚¬íšŒ">
                    </div>

                    <label>í‰ê°€ í•­ëª© (ë§Œì  / ë°˜ì˜ë¹„ìœ¨)</label>
                    <div id="criteriaList"></div>
                    
                    <button class="btn-add" onclick="addRow()">+ í•­ëª© ì¶”ê°€</button>
                    <button id="saveBtn" class="btn-save" onclick="saveToFirebase()">ğŸ’¾ ê¸°ì¤€ ì €ì¥í•˜ê¸°</button>
                    <button id="cancelBtn" class="btn-cancel" onclick="resetForm()">ì·¨ì†Œ (ì…ë ¥ ì´ˆê¸°í™”)</button>
                </div>
            </div>

            <div class="right-panel">
                <div class="list-header">
                    <h3 style="margin:0; color:#555;">ğŸ“‚ ë“±ë¡ëœ í‰ê°€ ê¸°ì¤€ ëª©ë¡</h3>
                    <select id="sortFilter" class="sort-select" onchange="handleFilterChange()">
                        <option value="custom">êµê³¼ ê¸°ë³¸ìˆœ (êµ­ì˜ìˆ˜...)</option>
                        <option value="name">ê³¼ëª© ê°€ë‚˜ë‹¤ìˆœ (ã„±-ã…)</option>
                        <option value="latest">ìµœì‹  ë“±ë¡ìˆœ</option>
                    </select>
                </div>
                
                <div id="savedPlansList"></div>
            </div>

        </div>
    </div>

    <footer class="main-footer">
        Copyright Â© ì—­ì‚¬êµì‚¬ ë°©ì¬ì„. All rights reserved.
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, orderBy, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
          apiKey: "AIzaSyAOlPQ5PFmL0zxmGrGcuEBnqBXisph7kPU",
          authDomain: "history-quiz-yongsin.firebaseapp.com",
          projectId: "history-quiz-yongsin",
          storageBucket: "history-quiz-yongsin.firebasestorage.app",
          messagingSenderId: "177587430482",
          appId: "1:177587430482:web:1188e0f661368040c3ab8b",
          measurementId: "G-YG2SLS45D8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let editingDocId = null;
        let allPlansData = [];
        let timerInterval = null;

        // êµê³¼ëª© ìš°ì„ ìˆœìœ„
        const subjectPriority = {
            "êµ­ì–´": 1, "ì˜ì–´": 2, "ìˆ˜í•™": 3, 
            "ì‚¬íšŒ": 4, "ì—­ì‚¬": 5, "í•œêµ­ì‚¬": 5, 
            "ë„ë•": 6, "ê³¼í•™": 7, "ê¸°ìˆ ê°€ì •": 8, "ê¸°ê°€": 8, 
            "ì²´ìœ¡": 9, "ìŒì•…": 10, "ë¯¸ìˆ ": 11, 
            "í•œë¬¸": 12, "ì •ë³´": 13, "ì§„ë¡œ": 14
        };

        // --- [1. ë³´ì•ˆ ë° ì„¸ì…˜ ë¡œì§] ---
        
        // ë©”ì¸ ëŒ€ì‹œë³´ë“œ URL
        const MAIN_DASHBOARD_URL = 'teacher.html';

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
        onAuthStateChanged(auth, (user) => {
            if (!user || user.email !== "westoria28@gmail.com") {
                // ë¹„ë¡œê·¸ì¸ ë˜ëŠ” ê¶Œí•œ ì—†ëŠ” ê³„ì •ì¼ ê²½ìš° ì¦‰ì‹œ ì¶”ë°©
                alert("ğŸš« ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ê´€ë¦¬ì ì „ìš©)");
                signOut(auth).then(() => {
                    window.location.href = MAIN_DASHBOARD_URL;
                });
                return;
            }

            // [ì¸ì¦ ì„±ê³µ]
            document.getElementById('loadingOverlay').style.display = 'none';
            
            // 1. ì‚¬ìš©ì ì´ë¦„ í‘œì‹œ
            const userName = user.displayName || "ë°©ì¬ì„";
            document.getElementById('welcomeMsg').innerText = `${userName} ì„ ìƒë‹˜, í™”ì´íŒ…!`;

            // 2. ì„¸ì…˜ íƒ€ì´ë¨¸ ì‹œì‘ (localStorage ì—°ë™)
            startSessionTimer();

            // 3. ë°ì´í„° ë¡œë“œ ì‹œì‘
            loadSavedPlans();
            addRow();
        });

        // ì„¸ì…˜ íƒ€ì´ë¨¸ ê¸°ëŠ¥
        function startSessionTimer() {
            // teacher.htmlì—ì„œ ì„¤ì •í•œ ë§Œë£Œì‹œê°„ ê°€ì ¸ì˜¤ê¸°
            let expiryTime = localStorage.getItem("teacherSessionExpiry");
            
            // ë§Œì•½ ì—†ìœ¼ë©´(ì§ì ‘ ì ‘ì† ë“±) í˜„ì¬ ì‹œê°„ + 60ë¶„ìœ¼ë¡œ ìƒˆë¡œ ì„¤ì • (ë³´ì•ˆìƒ í‚¥ì´ ë§ì§€ë§Œ í¸ì˜ìƒ ì„¸ì…˜ ìƒì„±)
            if (!expiryTime) {
                expiryTime = Date.now() + (60 * 60 * 1000);
                localStorage.setItem("teacherSessionExpiry", expiryTime);
            }

            const timerDisplay = document.querySelector("#sessionTimer span");

            timerInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = parseInt(expiryTime) - now;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.");
                    handleLogout();
                } else {
                    const minutes = Math.floor(timeLeft / 60000);
                    const seconds = Math.floor((timeLeft % 60000) / 1000);
                    timerDisplay.innerText = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                }
            }, 1000);
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        window.handleLogout = async () => {
            if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                localStorage.removeItem("teacherSessionExpiry"); // ì„¸ì…˜ ì‚­ì œ
                await signOut(auth);
                window.location.href = MAIN_DASHBOARD_URL;
            }
        };

        // ë¡œê³  í´ë¦­ ì‹œ ì´ë™
        window.goMain = () => {
            window.location.href = "teacher-test.html"; // ìš”ì²­í•˜ì‹  teacher-test.html (ì¶”í›„ teacher.htmlë¡œ ë³€ê²½ ê°€ëŠ¥)
        };

        // --- [2. UI ë° ê¸°ì¡´ ë¡œì§] ---

        window.toggleMobileMenu = () => {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('open');
        };

        // ëª¨ë°”ì¼ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('mobileMenu');
            const btn = document.querySelector('.hamburger-btn');
            if (menu.classList.contains('open') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.remove('open');
            }
        });

        window.handleFilterChange = () => { renderPlansList(); };

        async function loadSavedPlans() {
            const listDiv = document.getElementById('savedPlansList');
            listDiv.innerHTML = '<div class="empty-msg">ë¡œë”© ì¤‘...</div>';

            try {
                const q = query(collection(db, "grading_plans"), orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allPlansData = [];
                querySnapshot.forEach(doc => { allPlansData.push({ id: doc.id, ...doc.data() }); });
                renderPlansList();

            } catch (e) { console.error("Error:", e); listDiv.innerHTML = '<div class="empty-msg">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>'; }
        }

        function renderPlansList() {
            const year = document.getElementById('yearFilter').value;
            const semester = document.getElementById('semesterFilter').value;
            const grade = document.getElementById('gradeFilter').value;
            const sortType = document.getElementById('sortFilter').value;
            
            const listDiv = document.getElementById('savedPlansList');
            listDiv.innerHTML = '';

            let filtered = allPlansData.filter(plan => {
                const pYear = plan.academicYear || "2025";
                const pSem = plan.semester || "1í•™ê¸°";
                const pGrade = plan.grade || "1í•™ë…„"; 
                return pYear === year && pSem === semester && pGrade === grade;
            });

            filtered.sort((a, b) => {
                if (sortType === 'name') {
                    return a.subject.localeCompare(b.subject);
                } else if (sortType === 'custom') {
                    const scoreA = subjectPriority[a.subject] || 999;
                    const scoreB = subjectPriority[b.subject] || 999;
                    if (scoreA !== scoreB) return scoreA - scoreB;
                    return a.subject.localeCompare(b.subject);
                } else {
                    const timeA = a.createdAt ? a.createdAt.seconds : 0;
                    const timeB = b.createdAt ? b.createdAt.seconds : 0;
                    return timeB - timeA;
                }
            });

            if (filtered.length === 0) {
                listDiv.innerHTML = '<div class="empty-msg">ë“±ë¡ëœ ê¸°ì¤€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œ ë“±ë¡í•´ë³´ì„¸ìš”!</div>';
                return;
            }

            filtered.forEach(data => {
                const card = document.createElement('div');
                card.className = 'plan-card';
                const summary = data.items.map(i => `<span style="display:inline-block; margin-right:5px; color:#555;">â€¢ ${i.name}(${i.ratio}%)</span>`).join('');
                const displayGrade = data.grade || '1í•™ë…„';

                card.innerHTML = `
                    <div class="plan-info">
                        <h3>${data.subject}</h3>
                        <div class="plan-meta">${data.academicYear || '2025'}í•™ë…„ë„ ${data.semester} [${displayGrade}]</div>
                        <div class="plan-items">${summary}</div>
                    </div>
                    <div class="plan-actions">
                        <button class="btn-sm btn-edit" onclick="startEdit('${data.id}')">ìˆ˜ì •</button>
                        <button class="btn-sm btn-delete" onclick="deletePlan('${data.id}')">ì‚­ì œ</button>
                    </div>
                `;
                listDiv.appendChild(card);
            });
        }

        window.startEdit = (id) => {
            const data = allPlansData.find(p => p.id === id);
            if(!data) return;
            editingDocId = id;
            
            if(data.academicYear) document.getElementById('yearFilter').value = data.academicYear;
            document.getElementById('semesterFilter').value = data.semester || "1í•™ê¸°";
            document.getElementById('gradeFilter').value = data.grade || "1í•™ë…„";
            
            renderPlansList();

            document.getElementById('subjectName').value = data.subject;
            const listDiv = document.getElementById('criteriaList');
            listDiv.innerHTML = '';
            data.items.forEach(item => addRow(item));

            document.getElementById('saveBtn').innerText = "ğŸ”„ ìˆ˜ì •ì‚¬í•­ ì €ì¥";
            document.getElementById('saveBtn').style.backgroundColor = "#f39c12";
            document.getElementById('cancelBtn').style.display = "block";
            document.getElementById('formTitle').innerText = "ğŸ“ í‰ê°€ ê¸°ì¤€ ìˆ˜ì • ëª¨ë“œ";
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.deletePlan = async (id) => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\në³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) {
                try {
                    await deleteDoc(doc(db, "grading_plans", id));
                    allPlansData = allPlansData.filter(p => p.id !== id);
                    renderPlansList();
                    if(editingDocId === id) resetForm();
                } catch(e) { alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message); }
            }
        };

        window.resetForm = () => {
            editingDocId = null;
            document.getElementById('subjectName').value = '';
            document.getElementById('criteriaList').innerHTML = '';
            addRow(); 
            document.getElementById('saveBtn').innerText = "ğŸ’¾ ê¸°ì¤€ ì €ì¥í•˜ê¸°";
            document.getElementById('saveBtn').style.backgroundColor = "#2ecc71";
            document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('formTitle').innerText = "âœï¸ í‰ê°€ ê¸°ì¤€ ë“±ë¡";
        };

        window.addRow = (data = null) => {
            const div = document.createElement('div');
            div.className = 'criteria-row';
            
            const type = data ? data.type : "ì§€í•„";
            const name = data ? data.name : "";
            const max = data ? data.maxScore : "";
            const ratio = data ? data.ratio : "";

            div.innerHTML = `
                <select class="c-type">
                    <option value="ì§€í•„" ${type==='ì§€í•„'?'selected':''}>ì§€í•„</option>
                    <option value="ìˆ˜í–‰" ${type==='ìˆ˜í–‰'?'selected':''}>ìˆ˜í–‰</option>
                </select>
                <input type="text" placeholder="í•­ëª©ëª…" class="c-name" value="${name}">
                <input type="number" placeholder="ë§Œì " class="c-max" value="${max}">
                <input type="number" placeholder="%" class="c-ratio" value="${ratio}">
                <button class="remove-btn" onclick="this.parentElement.remove()">x</button>
            `;
            document.getElementById('criteriaList').appendChild(div);
        };

        window.saveToFirebase = async () => {
            const user = auth.currentUser;
            if (!user || user.email !== "westoria28@gmail.com") { alert("ê¶Œí•œ ì—†ìŒ"); return; }

            const academicYear = document.getElementById('yearFilter').value;
            const semester = document.getElementById('semesterFilter').value;
            const grade = document.getElementById('gradeFilter').value;
            const subject = document.getElementById('subjectName').value.trim();
            if (!subject) { alert("ê³¼ëª©ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            const rows = document.querySelectorAll('.criteria-row');
            const items = [];
            let totalRatio = 0;

            for (const row of rows) {
                const type = row.querySelector('.c-type').value;
                const name = row.querySelector('.c-name').value.trim();
                const maxScore = row.querySelector('.c-max').value;
                const ratio = row.querySelector('.c-ratio').value;
                if (!name || !maxScore || !ratio) { alert("ë¹ˆì¹¸ì„ ì±„ì›Œì£¼ì„¸ìš”."); return; }
                totalRatio += Number(ratio);
                items.push({ type, name, maxScore: Number(maxScore), ratio: Number(ratio) });
            }

            if (items.length === 0) { alert("í•­ëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”."); return; }
            if (totalRatio !== 100) { alert(`ë¹„ìœ¨ í•©ê³„ê°€ ${totalRatio}% ì…ë‹ˆë‹¤. 100%ë¥¼ ë§ì¶°ì£¼ì„¸ìš”.`); return; }

            try {
                const saveData = { academicYear, semester, grade, subject, items, updatedAt: new Date() };
                if (editingDocId) {
                    await updateDoc(doc(db, "grading_plans", editingDocId), saveData);
                    const idx = allPlansData.findIndex(p => p.id === editingDocId);
                    if(idx !== -1) allPlansData[idx] = { id: editingDocId, ...saveData };
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else {
                    saveData.createdAt = new Date();
                    saveData.teacherEmail = user.email;
                    const docRef = await addDoc(collection(db, "grading_plans"), saveData);
                    allPlansData.unshift({ id: docRef.id, ...saveData });
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                }
                resetForm(); renderPlansList();
            } catch (e) { console.error("Error:", e); alert("ì €ì¥ ì‹¤íŒ¨: " + e.message); }
        };
    </script>
</body>
</html>
